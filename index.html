<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Planner Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --mocha: #bda38f; --latte: #e8e2d6; --dark-text: #433422; --deep-banner: #333333; }
        body { background-color: var(--latte); color: var(--dark-text); font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        [v-cloak] { display: none; }
        .card-muji { background: rgba(255, 255, 255, 0.85); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .status-banner { background: var(--deep-banner); color: white; border-radius: 20px; padding: 24px; }
        .timeline-line { position: absolute; left: 42px; top: 0; bottom: 0; width: 1px; background: rgba(67, 52, 34, 0.15); z-index: 0; }
        .time-input { color: #bbbbbb; text-align: center; font-weight: bold; width: 100%; background: transparent; border: none; outline: none; font-size: 16px; }
        .time-input.active { color: var(--dark-text); }
        .time-badge { background: white; border-radius: 14px; width: 84px; padding: 10px 4px; text-align: center; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .input-box { background: #ffffff; border-radius: 12px; padding: 10px 14px; width: 100%; font-size: 14px; border: 1px solid rgba(0,0,0,0.05); outline: none; }
        #map { height: 350px; border-radius: 24px; border: 6px solid white; width: 100%; }
        .loc-tag { background: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="!isSetup" class="fixed inset-0 z-[100] bg-[#e8e2d6] flex flex-col items-center justify-center px-8">
            <div class="card-muji w-full max-w-sm p-10 space-y-6 text-center">
                <h1 class="text-2xl font-bold">Travel Planner</h1>
                <div class="space-y-4">
                    <input v-model="setup.destination" placeholder="ç›®çš„åœ° (å¦‚: Tokyo)" class="input-box py-4 text-center">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" v-model="setup.startDate" class="input-box text-xs">
                        <input type="date" v-model="setup.endDate" class="input-box text-xs">
                    </div>
                    <button @click="finishSetup" class="w-full py-4 bg-[#333] text-white rounded-xl font-bold">START JOURNEY</button>
                </div>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto min-h-screen">
            <div class="px-6 pt-8">
                <div class="status-banner flex justify-between items-center shadow-xl">
                    <div>
                        <h2 class="text-2xl font-bold">{{ formattedDate }} ({{ currentDayName }})</h2>
                        <p class="text-xs opacity-70 mt-1 uppercase">ğŸ“ {{ setup.destination }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-black">{{ weather.temp }}Â°C</div>
                        <p class="text-[10px] font-bold opacity-70">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto px-6 space-x-3 my-6 no-scrollbar">
                <div v-for="d in totalDays" :key="d" @click="selectedDay = d"
                     :class="['flex-shrink-0 w-12 h-16 flex flex-col items-center justify-center rounded-2xl bg-white/40', { 'bg-[#333] text-white': selectedDay === d }]">
                    <span class="text-lg font-bold">{{ d }}</span>
                </div>
            </div>

            <main class="px-6 space-y-8 pb-24">
                <div class="flex space-x-8 text-sm font-bold border-b border-white/30 pb-2">
                    <button @click="tab = 'list'" :class="tab === 'list' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">è¡Œç¨‹</button>
                    <button @click="tab = 'map'; updateMapMarkers()" :class="tab === 'map' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åœ°åœ–</button>
                    <button @click="tab = 'finance'" :class="tab === 'finance' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åˆ†å¸³</button>
                </div>

                <div v-if="tab === 'list'" class="space-y-12 relative">
                    <div class="timeline-line"></div>
                    <div v-for="(p, i) in currentPlans" :key="i" class="relative flex items-start space-x-6">
                        <div class="flex flex-col items-center">
                            <div class="time-badge">
                                <select v-model="p.ampm" class="text-[10px] font-black block w-full text-center bg-transparent outline-none">
                                    <option value="ä¸Šåˆ">ä¸Šåˆ</option><option value="ä¸‹åˆ">ä¸‹åˆ</option>
                                </select>
                                <input type="text" v-model="p.time" maxlength="4"
                                       @focus="if(p.time === '00:00') p.time = ''"
                                       @blur="handleTimeBlur(p)"
                                       :class="['time-input mt-1', { 'active': p.time !== '00:00' }]">
                            </div>
                            <select v-model="p.transport" class="text-[10px] mt-2 bg-white rounded p-1 outline-none">
                                <option>ğŸš— äº¤é€š</option><option>ğŸš‡ åœ°éµ</option><option>ğŸš„ JR</option><option>ğŸš¶ æ­¥è¡Œ</option>
                            </select>
                        </div>
                        <div class="card-muji flex-grow p-5 space-y-4">
                            <input v-model="p.loc" placeholder="è¡Œç¨‹æ¨™é¡Œ" class="text-base font-bold bg-transparent outline-none w-full">
                            <div class="flex items-center bg-[#f9f9f9] rounded-xl px-3 border border-black/5">
                                <span class="text-sm mr-2">ğŸ“</span>
                                <input v-model="p.mapLink" placeholder="åœ°é»åç¨±" class="bg-transparent py-2 w-full text-sm outline-none">
                            </div>
                            <div class="flex items-center bg-[#f9f9f9] rounded-xl px-3 border border-black/5">
                                <span class="text-sm mr-2">ğŸ±</span>
                                <input v-model="p.food" placeholder="ç¾é£Ÿå®‰æ’" class="bg-transparent py-2 w-full text-sm outline-none">
                            </div>
                            <textarea v-model="p.note" placeholder="å‚™è¨»..." class="input-box h-16 bg-[#f9f9f9] text-xs resize-none text-left"></textarea>
                        </div>
                    </div>
                    <button @click="addPlan" class="w-full py-5 rounded-2xl border-2 border-dashed border-white/60 text-[10px] font-bold opacity-40">+ ADD PLAN</button>
                </div>

                <div v-show="tab === 'map'" class="space-y-4">
                    <div id="map"></div>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="p in currentPlans" v-if="p.mapLink" @click="focusLocation(p.mapLink)" class="loc-tag">
                            ğŸ“ {{ p.loc || p.mapLink }}
                        </div>
                    </div>
                </div>

                <div v-if="tab === 'finance'" class="card-muji p-8 space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/40 p-4 rounded-2xl">
                            <label class="text-[9px] font-bold opacity-40 block">åŒ¯ç‡ (TWD)</label>
                            <input type="number" v-model="finance.rate" class="w-full bg-transparent font-bold outline-none">
                        </div>
                        <div class="bg-white/40 p-4 rounded-2xl">
                            <label class="text-[9px] font-bold opacity-40 block">å¤–å¹£é‡‘é¡</label>
                            <input type="number" v-model="finance.amount" class="w-full bg-transparent font-bold outline-none">
                        </div>
                    </div>
                    <div class="bg-[#333] p-10 rounded-[30px] text-center text-white">
                        <p class="text-[10px] opacity-50 uppercase mb-2">Total TWD</p>
                        <p class="text-4xl font-black italic">NT$ {{ Math.round(finance.amount * finance.rate).toLocaleString() }}</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    isSetup: false,
                    tab: 'list',
                    selectedDay: 1,
                    setup: { destination: '', startDate: '', endDate: '' },
                    weather: { temp: '--', desc: 'æŠ“å–ä¸­' },
                    finance: { amount: 0, rate: 0.22 },
                    itineraryData: {},
                    map: null,
                    markers: []
                }
            },
            computed: {
                totalDays() {
                    if (!this.setup.startDate || !this.setup.endDate) return 1;
                    const s = new Date(this.setup.startDate);
                    const e = new Date(this.setup.endDate);
                    return Math.max(1, Math.ceil(Math.abs(e - s) / (86400000)) + 1);
                },
                formattedDate() {
                    if (!this.setup.startDate) return '';
                    const d = new Date(this.setup.startDate);
                    d.setDate(d.getDate() + (this.selectedDay - 1));
                    return (d.getMonth() + 1) + '/' + d.getDate();
                },
                currentDayName() {
                    if (!this.setup.startDate) return '';
                    const d = new Date(this.setup.startDate);
                    d.setDate(d.getDate() + (this.selectedDay - 1));
                    return 'æ˜ŸæœŸ' + ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                },
                currentPlans() {
                    const key = 'day_' + this.selectedDay;
                    if (!this.itineraryData[key]) this.itineraryData[key] = [];
                    return this.itineraryData[key];
                }
            },
            methods: {
                finishSetup() {
                    if(this.setup.destination) {
                        this.isSetup = true;
                        this.fetchWeather();
                    }
                },
                async fetchWeather() {
                    try {
                        const res = await fetch('https://wttr.in/' + encodeURIComponent(this.setup.destination) + '?format=j1');
                        const data = await res.json();
                        this.weather.temp = data.current_condition[0].temp_C;
                        this.weather.desc = data.current_condition[0].weatherDesc[0].value;
                    } catch (e) {
                        this.weather.temp = '15';
                        this.weather.desc = 'Sunny';
                    }
                },
                handleTimeBlur(p) {
                    let val = p.time.replace(/\D/g, '');
                    if (val.length === 0) p.time = '00:00';
                    else if (val.length <= 2) p.time = val.padStart(2, '0') + ':00';
                    else p.time = val.slice(0, 2) + ':' + val.slice(2, 4).padEnd(2, '0');
                },
                addPlan() {
                    this.currentPlans.push({ ampm: 'ä¸Šåˆ', time: '00:00', loc: '', mapLink: '', food: '', note: '', transport: 'ğŸš— äº¤é€š' });
                },
                updateMapMarkers() {
                    setTimeout(() => {
                        if (!this.map) {
                            this.map = L.map('map').setView([20, 0], 2);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                        }
                        this.markers.forEach(m => this.map.removeLayer(m));
                        this.markers = [];
                        this.currentPlans.forEach(p => {
                            if (p.mapLink) {
                                fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(p.mapLink))
                                    .then(r => r.json()).then(data => {
                                        if (data[0]) {
                                            const m = L.marker([data[0].lat, data[0].lon]).addTo(this.map).bindPopup(p.loc || p.mapLink);
                                            this.markers.push(m);
                                        }
                                    });
                            }
                        });
                    }, 300);
                },
                focusLocation(locName) {
                    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(locName))
                        .then(r => r.json()).then(data => {
                            if (data[0]) this.map.flyTo([data[0].lat, data[0].lon], 15);
                        });
                }
            },
            mounted() {
                const saved = localStorage.getItem('tripData_final');
                if(saved) {
                    const p = JSON.parse(saved);
                    this.itineraryData = p.itinerary || {};
                    this.setup = p.setup || this.setup;
                    if(this.setup.destination) {
                        this.isSetup = true;
                        this.fetchWeather();
                    }
                }
            },
            updated() {
                localStorage.setItem('tripData_final', JSON.stringify({
                    itinerary: this.itineraryData,
                    setup: this.setup
                }));
            }
        });
        app.mount('#app');
    </script>
</body>
</html>
