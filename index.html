<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muji Travel Itinerary</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --mocha: #bda38f;
            --latte: #e8e2d6; 
            --dark-text: #433422;
            --deep-bg: #3c3c3c; /* æ›¿æ›åŸæœ¬é†œç´«è‰²ç‚ºæ·±ç°è‰² */
            --pure-white: #ffffff;
        }
        body { 
            background-color: var(--latte); 
            color: var(--dark-text); 
            font-family: -apple-system, "PingFang TC", sans-serif;
            margin: 0; padding: 0;
        }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* çµ±ä¸€åœ“è§’å¡ç‰‡ */
        .card-muji { 
            background: rgba(255, 255, 255, 0.8); 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        /* é ‚éƒ¨æ·±è‰²é«˜å°æ¯”æ¡†æ¡† */
        .status-banner {
            background: var(--deep-bg);
            color: white;
            border-radius: 20px;
            padding: 24px;
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-line {
            position: absolute;
            left: 45px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #d1c7bc;
            z-index: 0;
        }

        .input-mini-card {
            background: white;
            border-radius: 10px;
            padding: 8px 12px;
            width: 100%;
            font-size: 13px;
            border: 1px solid rgba(0,0,0,0.05);
            outline: none;
        }

        .time-box {
            background: white;
            border-radius: 12px;
            width: 90px;
            padding: 10px 5px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .select-transport {
            background: #f8f8f8;
            border-radius: 8px;
            font-size: 10px;
            padding: 4px;
            text-align: center;
            width: 80px;
            margin-top: 6px;
            border: none;
            outline: none;
        }

        #map { height: 300px; border-radius: 20px; border: 5px solid white; }
    </style>
</head>
<body class="pb-20">
    <div id="app" v-cloak>
        <div v-if="!isSetup" class="fixed inset-0 z-[100] bg-[#e8e2d6] flex flex-col items-center justify-center px-10">
            <div class="card-muji w-full max-w-sm p-8 space-y-6">
                <div class="text-center mb-4">
                    <h1 class="text-2xl font-bold italic">My Travel Itinerary</h1>
                    <p class="text-xs opacity-50 tracking-widest mt-1">é–‹å•Ÿæ‚¨çš„æ—…ç¨‹</p>
                </div>
                
                <div class="space-y-4">
                    <input v-model="setup.destination" placeholder="ç›®çš„åœ° (ä¾‹å¦‚ï¼šæ±äº¬)" class="input-mini-card py-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] opacity-40 mb-1 block ml-1">START DATE</label>
                            <input type="date" v-model="setup.startDate" class="input-mini-card">
                        </div>
                        <div>
                            <label class="text-[10px] opacity-40 mb-1 block ml-1">END DATE</label>
                            <input type="date" v-model="setup.endDate" class="input-mini-card">
                        </div>
                    </div>
                    <div class="bg-white/50 p-3 rounded-xl text-center text-sm">
                        <span class="opacity-50 italic">Number of days: </span>
                        <span class="font-bold text-lg text-[#bda38f] ml-1">{{ totalDays }} Days</span>
                    </div>
                    <button @click="finishSetup" class="w-full py-4 bg-[#3c3c3c] text-white rounded-xl font-bold tracking-widest shadow-lg">START JOURNEY</button>
                </div>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto animate-in fade-in duration-500">
            <div class="px-6 pt-8">
                <div class="status-banner flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">{{ formattedCurrentDate }} ({{ currentDayOfWeek }})</h2>
                        <p class="text-sm opacity-70 mt-1">ğŸ“ {{ setup.destination }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold">{{ weather.temp }}Â°C</div>
                        <p class="text-[10px] tracking-tighter opacity-70">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto px-6 space-x-3 no-scrollbar my-6">
                <div v-for="d in totalDays" :key="d" @click="selectedDay = d"
                     :class="['flex-shrink-0 w-12 h-16 flex flex-col items-center justify-center rounded-2xl bg-white/40 transition-all', { 'bg-[#3c3c3c] text-white shadow-lg': selectedDay === d }]">
                    <span class="text-[8px] font-bold opacity-40">Day</span>
                    <span class="text-lg font-bold">{{ d }}</span>
                </div>
            </div>

            <main class="px-6 space-y-8">
                <div class="space-y-10 relative">
                    <div class="timeline-line"></div>
                    
                    <div v-for="(p, i) in currentPlans" :key="i" class="relative flex items-start space-x-6">
                        <div class="flex flex-col items-center">
                            <div class="time-box text-center">
                                <select v-model="p.ampm" class="text-[10px] font-bold block w-full outline-none text-center">
                                    <option value="AM">ä¸Šåˆ</option>
                                    <option value="PM">ä¸‹åˆ</option>
                                </select>
                                <input type="time" v-model="p.time" class="text-sm font-bold w-full text-center outline-none mt-1">
                            </div>
                            <select v-model="p.transport" class="select-transport">
                                <option value="ğŸš— äº¤é€š">ğŸš— äº¤é€š</option>
                                <option value="ğŸš‡ åœ°éµ">ğŸš‡ åœ°éµ</option>
                                <option value="ğŸšŒ å…¬è»Š">ğŸšŒ å…¬è»Š</option>
                                <option value="ğŸš„ JR/æ–°å¹¹ç·š">ğŸš„ JR</option>
                                <option value="âœˆï¸ é£›æ©Ÿ">âœˆï¸ é£›æ©Ÿ</option>
                                <option value="ğŸš• è¨ˆç¨‹è»Š">ğŸš• è¨ˆç¨‹è»Š</option>
                                <option value="ğŸš¶ æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option>
                            </select>
                        </div>

                        <div class="card-muji flex-grow p-5 space-y-3">
                            <div class="flex justify-between items-center">
                                <input v-model="p.loc" placeholder="è¡Œç¨‹æ¨™é¡Œ..." class="text-base font-bold bg-transparent outline-none w-full">
                                <button @click="removePlan(i)" class="text-xs opacity-10">âœ•</button>
                            </div>
                            
                            <div class="flex items-center">
                                <span class="text-xs mr-2">ğŸ“</span>
                                <input v-model="p.mapLink" placeholder="åœ°é»æˆ–åœ°åœ–é€£çµ..." class="input-mini-card">
                            </div>

                            <div class="flex items-center">
                                <span class="text-xs mr-2">ğŸ±</span>
                                <input v-model="p.food" placeholder="é å®šç¾é£Ÿè¡Œç¨‹..." class="input-mini-card">
                            </div>

                            <textarea v-model="p.note" placeholder="è©³ç´°å‚™è¨»..." class="input-mini-card h-16 resize-none" rows="2"></textarea>
                        </div>
                    </div>

                    <button @click="addPlan" class="w-full py-5 rounded-2xl border-2 border-dashed border-white/60 text-[10px] font-bold opacity-40 tracking-widest">+ ADD NEW PLAN</button>
                </div>

                <div class="py-10 text-center">
                    <button @click="resetApp" class="text-[10px] font-bold opacity-30 border-b border-black/20 pb-1">è¿”å›é¦–é ä¸¦é‡æ–°è¨­å®šç›®çš„åœ°</button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxZx7UnDg25ZcMDiTJRhSdwkiEApsVHjc",
            authDomain: "europe-trip-app.firebaseapp.com",
            databaseURL: "https://europe-trip-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "europe-trip-app",
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const dbRef = ref(db, 'trip_data_v5_final');

        const { createApp, ref: vueRef, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const isSetup = vueRef(false);
                const selectedDay = vueRef(1);
                const setup = vueRef({ destination: '', startDate: '', endDate: '' });
                const weather = vueRef({ temp: '11', desc: 'Sunny' });
                const itineraryData = vueRef({});

                const totalDays = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return 1;
                    const start = new Date(setup.value.startDate);
                    const end = new Date(setup.value.endDate);
                    return Math.max(1, Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1);
                });

                const formattedCurrentDate = computed(() => {
                    if (!setup.value.startDate) return '';
                    const d = new Date(setup.value.startDate);
                    d.setDate(d.getDate() + (selectedDay.value - 1));
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                });

                const currentDayOfWeek = computed(() => {
                    if (!setup.value.startDate) return '';
                    const d = new Date(setup.value.startDate);
                    d.setDate(d.getDate() + (selectedDay.value - 1));
                    return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                });

                const fetchRealWeather = async () => {
                    try {
                        const res = await fetch(`https://wttr.in/${setup.value.destination}?format=j1`);
                        const data = await res.json();
                        weather.value = { 
                            temp: data.current_condition[0].temp_C, 
                            desc: data.current_condition[0].weatherDesc[0].value 
                        };
                    } catch (e) { console.log("Weather error, use default"); }
                };

                const resetApp = () => { isSetup.value = false; };
                const finishSetup = () => { if(setup.value.destination) { isSetup.value = true; fetchRealWeather(); } };

                onValue(dbRef, (snap) => { if(snap.val()) itineraryData.value = snap.val(); });
                watch(itineraryData, (newData) => { set(dbRef, JSON.parse(JSON.stringify(newData))); }, { deep: true });

                const currentPlans = computed(() => {
                    const key = `day_${selectedDay.value}`;
                    if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    return itineraryData.value[key];
                });

                const addPlan = () => currentPlans.value.push({ ampm: 'AM', time: '09:00', transport: 'ğŸš— äº¤é€š', loc: '', mapLink: '', food: '', note: '' });
                const removePlan = (idx) => currentPlans.value.splice(idx, 1);

                return { isSetup, setup, totalDays, selectedDay, itineraryData, currentPlans, weather, formattedCurrentDate, currentDayOfWeek, finishSetup, addPlan, removePlan, resetApp };
            }
        }).mount('#app');
    </script>
</body>
</html>
