<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Travel Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --mocha: #bda38f;
            --latte: #e8e2d6; 
            --dark-text: #433422;
            --deep-banner: #333333;
        }
        body { background-color: var(--latte); color: var(--dark-text); font-family: -apple-system, "PingFang TC", sans-serif; margin: 0; padding: 0; }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .card-muji { background: rgba(255, 255, 255, 0.85); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .status-banner { background: var(--deep-banner); color: white; border-radius: 20px; padding: 24px; }
        .timeline-line { position: absolute; left: 42px; top: 0; bottom: 0; width: 1px; background: rgba(67, 52, 34, 0.15); z-index: 0; }
        
        /* çµ±ä¸€è¼¸å…¥æ¡†æ¨£å¼ */
        .input-box { background: #ffffff; border-radius: 12px; padding: 10px 14px; width: 100%; font-size: 14px; border: 1px solid rgba(0,0,0,0.05); outline: none; transition: color 0.3s; }
        
        /* æ™‚é–“è¼¸å…¥æ§åˆ¶ */
        .time-input { color: #ccc; text-align: center; font-weight: bold; width: 100%; background: transparent; border: none; outline: none; }
        .time-input.has-value { color: var(--dark-text); }
        
        .time-badge { background: white; border-radius: 14px; width: 84px; padding: 10px 4px; text-align: center; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .select-transport { background: white; border-radius: 8px; font-size: 11px; padding: 4px; text-align: center; width: 84px; margin-top: 8px; border: 1px solid rgba(0,0,0,0.05); outline: none; }
        #map { height: 400px; border-radius: 24px; border: 6px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .icon-prefix { font-size: 14px; margin-right: 8px; flex-shrink: 0; }
    </style>
</head>
<body class="pb-24">
    <div id="app" v-cloak>
        <div v-if="!isSetup" class="fixed inset-0 z-[100] bg-[#e8e2d6] flex flex-col items-center justify-center px-8">
            <div class="card-muji w-full max-w-sm p-10 space-y-6">
                <div class="text-center">
                    <h1 class="text-2xl font-bold tracking-tight">Travel Planner</h1>
                    <p class="text-[10px] opacity-40 uppercase tracking-[0.2em] mt-2">é–‹å•Ÿæ‚¨çš„æ—…ç¨‹</p>
                </div>
                <div class="space-y-4">
                    <input v-model="setup.destination" placeholder="ç›®çš„åœ° (ä¾‹å¦‚ï¼šæ±äº¬)" class="input-box py-4 text-center">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" v-model="setup.startDate" class="input-box text-xs">
                        <input type="date" v-model="setup.endDate" class="input-box text-xs">
                    </div>
                    <div class="bg-[#f2e8df] p-4 rounded-xl text-center text-sm">
                        <span class="opacity-60 italic">Number of days:</span>
                        <span class="text-xl font-black ml-2 text-[#5e503f]">{{ totalDays }}</span>
                    </div>
                    <button @click="finishSetup" class="w-full py-4 bg-[#333333] text-white rounded-xl font-bold tracking-widest active:scale-95 transition-all">START JOURNEY</button>
                </div>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto animate-in fade-in duration-500">
            <div class="px-6 pt-8">
                <div class="status-banner flex justify-between items-center shadow-xl">
                    <div>
                        <h2 class="text-2xl font-bold">{{ formattedDate }} ({{ currentDayName }})</h2>
                        <p class="text-xs opacity-70 mt-1 uppercase">ğŸ“ {{ setup.destination }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-black">{{ weather.temp }}Â°C</div>
                        <p class="text-[10px] font-bold opacity-70">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto px-6 space-x-3 no-scrollbar my-6">
                <div v-for="d in totalDays" :key="d" @click="selectedDay = d; fetchWeather()"
                     :class="['flex-shrink-0 w-12 h-16 flex flex-col items-center justify-center rounded-2xl bg-white/40 transition-all', { 'bg-[#333333] text-white shadow-lg': selectedDay === d }]">
                    <span class="text-[8px] font-bold opacity-40">Day</span>
                    <span class="text-lg font-bold">{{ d }}</span>
                </div>
            </div>

            <main class="px-6 space-y-8">
                <div class="flex space-x-8 text-sm font-bold border-b border-white/30 pb-2">
                    <button @click="tab = 'list'" :class="tab === 'list' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">è¡Œç¨‹</button>
                    <button @click="tab = 'map'; updateMapMarkers()" :class="tab === 'map' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åœ°åœ–</button>
                    <button @click="tab = 'finance'" :class="tab === 'finance' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åˆ†å¸³</button>
                </div>

                <div v-if="tab === 'list'" class="space-y-12 relative">
                    <div class="timeline-line"></div>
                    <div v-for="(p, i) in currentPlans" :key="i" class="relative flex items-start space-x-6">
                        <div class="flex flex-col items-center">
                            <div class="time-badge">
                                <select v-model="p.ampm" class="text-[10px] font-black block w-full outline-none text-center bg-transparent">
                                    <option value="ä¸Šåˆ">ä¸Šåˆ</option><option value="ä¸‹åˆ">ä¸‹åˆ</option>
                                </select>
                                <input type="text" v-model="p.time" 
                                       @focus="if(p.time === '00:00') p.time = ''" 
                                       @blur="if(p.time === '') p.time = '00:00'"
                                       :class="['time-input mt-1', { 'has-value': p.time !== '00:00' }]">
                            </div>
                            <select v-model="p.transport" class="select-transport">
                                <option value="ğŸš— äº¤é€š">ğŸš— äº¤é€š</option><option value="ğŸš‡ åœ°éµ">ğŸš‡ åœ°éµ</option>
                                <option value="ğŸš„ JR">ğŸš„ JR</option><option value="ğŸšŒ å…¬è»Š">ğŸšŒ å…¬è»Š</option>
                                <option value="ğŸš¶ æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option><option value="ğŸš• è¨ˆç¨‹è»Š">ğŸš• è¨ˆç¨‹è»Š</option>
                            </select>
                        </div>
                        <div class="card-muji flex-grow p-5 space-y-4">
                            <div class="flex justify-between items-start">
                                <input v-model="p.loc" placeholder="è¡Œç¨‹æ¨™é¡Œ..." class="text-base font-bold bg-transparent outline-none w-full">
                                <button @click="removePlan(i)" class="text-xs opacity-10">âœ•</button>
                            </div>
                            
                            <div class="flex items-center bg-[#f9f9f9] rounded-xl px-3 border border-black/5">
                                <span class="icon-prefix">ğŸ“</span>
                                <input v-model="p.mapLink" placeholder="åœ°é»åç¨± (è‡ªå‹•é€£å‹•åœ°åœ–)" class="bg-transparent py-2 w-full text-sm outline-none">
                                <a v-if="p.mapLink" :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(p.mapLink)" target="_blank" class="text-[10px] text-blue-400 ml-1">Go</a>
                            </div>

                            <div class="flex items-center bg-[#f9f9f9] rounded-xl px-3 border border-black/5">
                                <span class="icon-prefix">ğŸ±</span>
                                <input v-model="p.food" placeholder="é è¨ˆç¾é£Ÿ..." class="bg-transparent py-2 w-full text-sm outline-none">
                            </div>

                            <textarea v-model="p.note" placeholder="å‚™è¨»..." class="input-box h-16 resize-none opacity-60 text-left bg-[#f9f9f9]"></textarea>
                        </div>
                    </div>
                    <button @click="addPlan" class="w-full py-5 rounded-2xl border-2 border-dashed border-white/60 text-[10px] font-bold opacity-40">+ ADD NEW PLAN</button>
                    <div class="pt-10 text-center"><button @click="isSetup = false" class="text-[10px] opacity-30 border-b border-black/10">é‡æ–°è¨­å®šæ—…ç¨‹</button></div>
                </div>

                <div v-show="tab === 'map'" class="space-y-4">
                    <div id="map"></div>
                    <p class="text-[10px] opacity-40 text-center">è‡ªå‹•é‡˜é¸ç•¶å¤©æ‰€æœ‰åœ°é»ï¼Œè—è‰²é»ç‚ºæ‚¨çš„ä½ç½®</p>
                </div>

                <div v-if="tab === 'finance'" class="card-muji p-8 space-y-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-white/40 p-4 rounded-2xl">
                            <span class="text-xs font-bold">åŒ¯ç‡æ›ç®— (1 å¤–å¹£ = ? å°å¹£)</span>
                            <input type="number" v-model="finance.rate" class="w-20 text-right bg-transparent border-b border-black/20 outline-none font-bold text-mocha">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/40 p-4 rounded-2xl text-center">
                                <label class="text-[9px] font-bold opacity-40 block mb-1">è¼¸å…¥å¤–å¹£é‡‘é¡</label>
                                <input type="number" v-model="finance.amount" class="w-full bg-transparent text-xl font-black outline-none text-center">
                            </div>
                            <div class="bg-white/40 p-4 rounded-2xl text-center">
                                <label class="text-[9px] font-bold opacity-40 block mb-1">å¹³åˆ†äººæ•¸</label>
                                <input type="number" v-model="finance.ppl" class="w-full bg-transparent text-xl font-black outline-none text-center">
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#333] p-10 rounded-[30px] text-center text-white shadow-2xl relative overflow-hidden">
                        <p class="text-[10px] font-bold opacity-50 uppercase mb-2 tracking-[0.2em]">Total Amount (TWD)</p>
                        <p class="text-4xl font-black italic mb-2">NT$ {{ Math.round(finance.amount * finance.rate).toLocaleString() }}</p>
                        <div class="h-[1px] bg-white/10 my-4"></div>
                        <p class="text-[10px] font-bold opacity-50 uppercase mb-1">Per Person</p>
                        <p class="text-2xl font-bold text-[#bda38f]">NT$ {{ Math.round((finance.amount * finance.rate) / finance.ppl).toLocaleString() }}</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAxZx7UnDg25ZcMDiTJRhSdwkiEApsVHjc", authDomain: "europe-trip-app.firebaseapp.com", databaseURL: "https://europe-trip-app-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "europe-trip-app" };
        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const dbRef = ref(db, 'trip_final_pro_v9');

        const { createApp, ref: vueRef, computed, watch } = Vue;

        createApp({
            setup() {
                const isSetup = vueRef(false);
                const tab = vueRef('list');
                const selectedDay = vueRef(1);
                const setup = vueRef({ destination: '', startDate: '', endDate: '' });
                const weather = vueRef({ temp: '--', desc: 'Fetching...' });
                const finance = vueRef({ amount: 0, rate: 0.22, ppl: 2 });
                const itineraryData = vueRef({});

                const totalDays = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return 1;
                    const s = new Date(setup.value.startDate); const e = new Date(setup.value.endDate);
                    return Math.max(1, Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) + 1);
                });

                const formattedDate = computed(() => {
                    if (!setup.value.startDate) return '';
                    const d = new Date(setup.value.startDate); d.setDate(d.getDate() + (selectedDay.value - 1));
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                });

                const currentDayName = computed(() => {
                    if (!setup.value.startDate) return '';
                    const d = new Date(setup.value.startDate); d.setDate(d.getDate() + (selectedDay.value - 1));
                    return 'æ˜ŸæœŸ' + ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                });

                const fetchWeather = async () => {
                    try {
                        const res = await fetch(`https://wttr.in/${encodeURIComponent(setup.value.destination)}?format=j1`);
                        const data = await res.json();
                        weather.value = { temp: data.current_condition[0].temp_C, desc: data.current_condition[0].weatherDesc[0].value };
                    } catch (e) { weather.value = { temp: '15', desc: 'Sunny' }; }
                };

                const finishSetup = () => { if(setup.value.destination) { isSetup.value = true; fetchWeather(); } };

                onValue(dbRef, (snap) => { if(snap.val()) itineraryData.value = snap.val(); });
                watch(itineraryData, (newData) => { set(dbRef, JSON.parse(JSON.stringify(newData))); }, { deep: true });

                const currentPlans = computed(() => {
                    const key = `day_${selectedDay.value}`;
                    if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    return itineraryData.value[key];
                });

                const addPlan = () => currentPlans.value.push({ ampm: 'ä¸Šåˆ', time: '00:00', transport: 'ğŸš— äº¤é€š', loc: '', mapLink: '', food: '', note: '' });
                const removePlan = (idx) => currentPlans.value.splice(idx, 1);

                let map, markerLayer;
                const updateMapMarkers = async () => {
                    tab.value = 'map';
                    setTimeout(async () => {
                        if (!map) {
                            map = L.map('map').setView([35.6895, 139.6917], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                            markerLayer = L.layerGroup().addTo(map);
                        }
                        markerLayer.clearLayers();

                        // è—è‰²é»ä»£è¡¨ç¾åœ¨ä½ç½®
                        navigator.geolocation.getCurrentPosition(pos => {
                            const cur = [pos.coords.latitude, pos.coords.longitude];
                            L.circleMarker(cur, { radius: 8, color: '#4A90E2', fillColor: '#4A90E2', fillOpacity: 0.8 }).addTo(markerLayer).bindPopup("æ‚¨çš„ä½ç½®");
                        });

                        // é‡˜é¸ç•¶å¤©è¡Œç¨‹åœ°é»
                        const bounds = [];
                        for (let p of currentPlans.value) {
                            if (p.mapLink) {
                                try {
                                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(p.mapLink)}`);
                                    const data = await res.json();
                                    if (data[0]) {
                                        const latlng = [data[0].lat, data[0].lon];
                                        L.marker(latlng).addTo(markerLayer).bindPopup(`<b>${p.loc || 'åœ°é»'}</b><br>${p.mapLink}`);
                                        bounds.push(latlng);
                                    }
                                } catch (e) { console.error(e); }
                            }
                        }
                        if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
                    }, 400);
                };

                return { isSetup, setup, totalDays, tab, selectedDay, finance, itineraryData, currentPlans, weather, formattedDate, currentDayName, finishSetup, addPlan, removePlan, fetchWeather, updateMapMarkers };
            }
        }).mount('#app');
    </script>
</body>
</html>
