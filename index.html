<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Travel Itinerary</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --mocha: #bda38f;
            --latte: #e8e2d6; /* 參考圖的背景灰調奶茶色 */
            --dark-text: #5e503f;
            --pure-white: #ffffff;
        }
        body { 
            background-color: var(--latte); 
            color: var(--dark-text); 
            font-family: -apple-system, "PingFang TC", sans-serif;
            margin: 0; padding: 0;
            background-image: radial-gradient(circle at 90% 10%, rgba(189,163,143,0.1) 0%, transparent 40%);
        }

        /* 幾何線條裝飾 (復刻參考圖) */
        .deco-circle {
            position: fixed; width: 200px; height: 200px;
            border: 1px solid rgba(94, 80, 63, 0.1);
            border-radius: 50%; z-index: -1;
        }
        .deco-1 { top: -50px; right: -50px; width: 300px; height: 300px; }
        .deco-2 { top: 20px; right: -80px; width: 200px; height: 200px; }

        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 圖片中的大圓角卡片樣式 */
        .card-muji { 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(10px);
            border-radius: 40px; 
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
        }
        
        /* 圖片中的純白輸入框 */
        .input-muji {
            background: var(--pure-white);
            border-radius: 12px;
            padding: 12px 16px;
            border: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        /* 顯眼的大按鈕 (參考圖底部的綠色調/灰色調按鈕) */
        .btn-confirm {
            background: #a9b3a0; /* 參考圖中的莫蘭迪綠按鈕色 */
            color: white;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-confirm:active { transform: scale(0.97); }

        .active-day {
            background: #d6cfc5 !important;
            color: var(--dark-text) !important;
            border: 1px solid rgba(0,0,0,0.05);
        }

        #map { height: 280px; border-radius: 40px; border: 8px solid white; }
    </style>
</head>
<body class="pb-24">
    <div class="deco-circle deco-1"></div>
    <div class="deco-circle deco-2"></div>

    <div id="app" v-cloak>
        <div v-if="!isSetup" class="fixed inset-0 z-[100] bg-[#e8e2d6] flex flex-col items-center justify-center px-8">
            <div class="card-muji w-full max-w-sm p-10 space-y-8 relative overflow-hidden">
                <div class="space-y-2">
                    <h1 class="text-3xl font-serif font-bold text-[#5e503f]">My Travel Itinerary</h1>
                    <p class="text-xs opacity-50 tracking-widest">開啟您的旅程</p>
                </div>
                
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold opacity-40 ml-1 uppercase">Destination</label>
                        <input v-model="setup.destination" @blur="detectCountry" placeholder="目的地" class="w-full input-muji outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold opacity-40 ml-1 uppercase">Start Date</label>
                        <input type="date" v-model="setup.startDate" class="w-full input-muji outline-none">
                    </div>
                    <button @click="finishSetup" class="btn-confirm w-full py-4 mt-4 shadow-lg">START JOURNEY</button>
                </div>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto animate-in fade-in duration-500">
            <header class="p-8 pb-4 flex justify-between items-start">
                <div class="space-y-1">
                    <h1 class="text-3xl font-serif font-bold tracking-tight">{{ setup.destination }}</h1>
                    <p class="text-[10px] font-bold opacity-30 tracking-[0.2em] uppercase">{{ config.currencyName }} / {{ config.lang }}</p>
                </div>
                <button @click="isSetup = false" class="text-xl opacity-40 p-2">≡</button>
            </header>

            <div class="flex overflow-x-auto px-6 space-x-3 no-scrollbar mb-8">
                <div v-for="d in 7" :key="d" @click="selectedDay = d"
                     :class="['flex-shrink-0 w-12 h-16 flex flex-col items-center justify-center rounded-2xl bg-white/40 transition-all', { 'active-day shadow-md': selectedDay === d }]">
                    <span class="text-[8px] font-bold opacity-40">Day</span>
                    <span class="text-lg font-bold">{{ d }}</span>
                </div>
            </div>

            <main class="px-6 space-y-6">
                <div class="flex space-x-6 text-sm font-bold border-b border-white/30 pb-2">
                    <button @click="tab = 'list'" :class="tab === 'list' ? 'opacity-100' : 'opacity-30'">行程</button>
                    <button @click="tab = 'map'; if(tab==='map')initMap()" :class="tab === 'map' ? 'opacity-100' : 'opacity-30'">地圖導航</button>
                    <button @click="tab = 'finance'" :class="tab === 'finance' ? 'opacity-100' : 'opacity-30'">分帳系統</button>
                </div>

                <div v-if="tab === 'list'" class="space-y-4">
                    <div v-for="(p, i) in currentPlans" :key="i" class="card-muji p-6 flex items-center space-x-4">
                        <div class="flex-shrink-0 w-12 h-12 bg-white/80 rounded-full flex items-center justify-center overflow-hidden">
                             <span class="text-[10px] opacity-20">LOC</span>
                        </div>
                        <div class="flex-grow">
                            <input type="time" v-model="p.time" class="text-[10px] font-bold text-[#bda38f] bg-transparent outline-none block mb-1">
                            <input v-model="p.loc" placeholder="地點名稱..." class="w-full text-base font-bold bg-transparent outline-none">
                        </div>
                        <button @click="removePlan(i)" class="text-xs opacity-20">✕</button>
                    </div>
                    <button @click="addPlan" class="w-full py-5 rounded-[30px] border-2 border-dashed border-white/50 text-[10px] font-bold opacity-40 uppercase tracking-widest">+ ADD NEW PLAN</button>
                </div>

                <div v-show="tab === 'map'" class="space-y-4">
                    <div id="map"></div>
                </div>

                <div v-if="tab === 'finance'" class="card-muji p-8 space-y-6">
                    <div class="flex justify-between items-center text-xs font-bold opacity-60">
                        <span>匯率 (1{{config.currencySymbol}})</span>
                        <input type="number" v-model="config.rate" class="w-16 text-right bg-transparent border-b border-dark-text/20 outline-none">
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white/40 p-4 rounded-3xl flex justify-between items-center">
                            <span class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Amount</span>
                            <input type="number" v-model="expense.foreign" class="w-24 text-right font-bold text-lg bg-transparent outline-none">
                        </div>
                        <div class="bg-white/40 p-4 rounded-3xl flex justify-between items-center">
                            <span class="text-[10px] font-bold opacity-40 uppercase tracking-widest">People</span>
                            <input type="number" v-model="expense.ppl" class="w-24 text-right font-bold text-lg bg-transparent outline-none">
                        </div>
                    </div>
                    <div class="bg-[#5e503f] p-8 rounded-[40px] text-center text-white shadow-xl">
                        <p class="text-[9px] font-bold opacity-50 uppercase tracking-[0.3em] mb-2">Total per person</p>
                        <p class="text-4xl font-serif font-bold italic">NT$ {{ Math.round((expense.foreign * config.rate) / expense.ppl).toLocaleString() }}</p>
                    </div>
                </div>
            </main>

            <div class="fixed bottom-8 left-1/2 -translate-x-1/2 flex items-center space-x-2 bg-white/80 backdrop-blur-md px-4 py-2 rounded-full shadow-sm border border-white/50">
                <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></div>
                <span class="text-[9px] font-bold opacity-30 uppercase tracking-tighter italic">Cloud Synchronized</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase 配置 (延用之前的 Key)
        const firebaseConfig = {
            apiKey: "AIzaSyAxZx7UnDg25ZcMDiTJRhSdwkiEApsVHjc",
            authDomain: "europe-trip-app.firebaseapp.com",
            databaseURL: "https://europe-trip-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "europe-trip-app",
            storageBucket: "europe-trip-app.firebasestorage.app",
            messagingSenderId: "328114172706",
            appId: "1:328114172706:web:88a10ea7820325cbf02b7b",
            measurementId: "G-3C0N9RLK54"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const dbRef = ref(db, 'trip_data_design_final');

        const { createApp, ref: vueRef, computed, watch } = Vue;

        createApp({
            setup() {
                const isSetup = vueRef(false);
                const tab = vueRef('list');
                const selectedDay = vueRef(1);
                const setup = vueRef({ destination: '', startDate: '' });
                const expense = vueRef({ foreign: 0, ppl: 2 });
                const itineraryData = vueRef({});
                const config = vueRef({ currencySymbol: '€', currencyName: 'EUR', rate: 35.2, lang: 'Europe', avgTemp: '18' });

                const detectCountry = () => {
                    const d = setup.value.destination.toLowerCase();
                    if (d.includes('tokyo') || d.includes('japan')) config.value = { currencySymbol: '¥', currencyName: 'JPY', rate: 0.22, lang: 'JP', avgTemp: '15' };
                    else if (d.includes('london') || d.includes('uk')) config.value = { currencySymbol: '£', currencyName: 'GBP', rate: 41.5, lang: 'UK', avgTemp: '12' };
                    else if (d.includes('korea')) config.value = { currencySymbol: '₩', currencyName: 'KRW', rate: 0.024, lang: 'KR', avgTemp: '10' };
                };

                const finishSetup = () => { if(setup.value.destination) isSetup.value = true; };

                onValue(dbRef, (snap) => { if(snap.val()) itineraryData.value = snap.val(); });
                watch(itineraryData, (newData) => { set(dbRef, JSON.parse(JSON.stringify(newData))); }, { deep: true });

                const currentPlans = computed(() => {
                    const key = `day_${selectedDay.value}`;
                    if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    return itineraryData.value[key];
                });

                const addPlan = () => currentPlans.value.push({ time: '09:00', loc: '' });
                const removePlan = (idx) => currentPlans.value.splice(idx, 1);

                let map;
                const initMap = () => {
                    setTimeout(() => {
                        if (map) map.remove();
                        map = L.map('map').setView([48.8566, 2.3522], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    }, 300);
                };

                return { isSetup, setup, config, tab, selectedDay, expense, itineraryData, currentPlans, detectCountry, finishSetup, addPlan, removePlan, initMap };
            }
        }).mount('#app');
    </script>
</body>
</html>
