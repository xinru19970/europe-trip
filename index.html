<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Travel Pro - Ultra</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --mocha: #bda38f; --dark-text: #2d2d2d; }
        
        /* èƒŒæ™¯åœ–ç‰‡è¨­å®š */
        body { 
            background-image: url('https://files.oaiusercontent.com/file-f38c67'); 
            background-size: cover; background-attachment: fixed; background-position: center;
            color: var(--dark-text); font-family: -apple-system, sans-serif; margin: 0; padding: 0; 
        }

        [v-cloak] { display: none; }
        .card-muji { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* æ™‚é–“å­—é«”æ ¼å¼ï¼šå¤§ã€ç²—ã€é»‘ */
        .time-style { font-size: 1.4rem; font-weight: 800; color: #000; display: flex; align-items: center; gap: 4px; }
        
        /* å´é‚Šèœå–®æ¨£å¼ */
        .side-menu { position: fixed; top: 0; right: 0; bottom: 0; width: 250px; background: white; z-index: 200; transform: translateX(100%); transition: 0.3s; padding: 40px 20px; }
        .side-menu.open { transform: translateX(0); }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; }

        #map { height: 400px; border-radius: 20px; width: 100%; border: 4px solid white; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        
        <button @click="menuOpen = true" class="fixed top-6 right-6 z-[160] p-3 bg-white/80 rounded-full shadow-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>

        <div v-if="menuOpen" class="menu-overlay" @click="menuOpen = false"></div>
        <div :class="['side-menu shadow-2xl', { 'open': menuOpen }]">
            <h3 class="text-xl font-black mb-8">åŠŸèƒ½é¸å–®</h3>
            <ul class="space-y-6">
                <li @click="resetToHome" class="flex items-center space-x-3 cursor-pointer"><span>ğŸ </span> <span class="font-bold">é¦–é  (é‡æ–°è¨­å®š)</span></li>
                <li @click="tab = 'members'; menuOpen = false" class="flex items-center space-x-3 cursor-pointer"><span>ğŸ‘¥</span> <span class="font-bold">æˆå“¡ç®¡ç†</span></li>
            </ul>
        </div>

        <div v-if="!isSetup" class="fixed inset-0 z-[100] flex items-center justify-center px-8 bg-white/20 backdrop-blur-md">
            <div class="card-muji w-full max-w-sm p-10 space-y-6">
                <h1 class="text-2xl font-black text-center">é–‹å§‹ä½ çš„æ—…ç¨‹</h1>
                <input v-model="setup.destination" placeholder="ç›®çš„åœ° (ä¾‹å¦‚ï¼šå€«æ•¦)" class="w-full p-4 rounded-xl border-none bg-gray-100 outline-none">
                <div class="grid grid-cols-2 gap-3 text-xs font-bold">
                    <div>é–‹å§‹ï¼š<input type="date" v-model="setup.startDate" class="w-full p-2 mt-1 rounded-lg"></div>
                    <div>çµæŸï¼š<input type="date" v-model="setup.endDate" class="w-full p-2 mt-1 rounded-lg"></div>
                </div>
                <button @click="finishSetup" class="w-full py-4 bg-black text-white rounded-xl font-bold">é€²å…¥è¡Œç¨‹è¦åŠƒ</button>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto min-h-screen px-6 pt-16 pb-24">
            
            <div class="flex overflow-x-auto space-x-3 no-scrollbar mb-6">
                <div v-for="d in totalDays" :key="d" @click="selectedDay = d"
                     :class="['px-5 py-2 rounded-full font-bold whitespace-nowrap transition-all', selectedDay === d ? 'bg-black text-white' : 'bg-white/60 text-gray-500']">
                    Day {{ d }}
                </div>
            </div>

            <div class="card-muji bg-black p-5 text-white mb-8 border-l-8 border-mocha">
                <div class="text-[10px] opacity-60 uppercase font-bold tracking-widest mb-1">Current Area</div>
                <input v-model="areaInfo[selectedDay]" placeholder="è¼¸å…¥å€åŸŸ (ä¾‹å¦‚ï¼šå¸‚å€ / é£¯åº— / æ¾€è°·)" class="bg-transparent text-xl font-black w-full outline-none placeholder:text-white/20">
            </div>

            <nav class="flex space-x-6 text-sm font-black border-b border-black/5 pb-2 mb-8">
                <button @click="tab = 'list'" :class="tab === 'list' ? 'border-b-2 border-black' : 'opacity-20'">è¡Œç¨‹</button>
                <button @click="tab = 'map'; updateMapMarkers()" :class="tab === 'map' ? 'border-b-2 border-black' : 'opacity-20'">åœ°åœ–</button>
                <button @click="tab = 'items'" :class="tab === 'items' ? 'opacity-100' : 'opacity-20'">å¿…å‚™ç”¨å“</button>
                <button @click="tab = 'finance'" :class="tab === 'finance' ? 'opacity-100' : 'opacity-20'">åˆ†å¸³</button>
            </nav>

            <div v-if="tab === 'list'" class="space-y-8">
                <div v-for="(p, i) in currentPlans" :key="i" class="card-muji p-6 space-y-4">
                    <div class="flex items-center justify-between border-b border-black/5 pb-3">
                        <div class="time-style">
                            <span>â°</span>
                            <button @click="p.ampm = p.ampm === 'ä¸Šåˆ' ? 'ä¸‹åˆ' : 'ä¸Šåˆ'" class="text-xs bg-black/5 px-2 py-1 rounded">{{ p.ampm }}</button>
                            <select v-model="p.time" class="bg-transparent outline-none cursor-pointer">
                                <option v-for="t in timeSlots" :key="t" :value="t">{{ t }}</option>
                            </select>
                        </div>
                        <button @click="currentPlans.splice(i, 1)" class="text-xs opacity-20">åˆªé™¤</button>
                    </div>

                    <div class="space-y-3">
                        <input v-model="p.loc" @click="goToMap(p.mapLink)" placeholder="è¡Œç¨‹æ¨™é¡Œ (é»æ“Šå¯è·³è‡³åœ°åœ–)" class="text-lg font-black bg-transparent w-full outline-none text-blue-800">
                        <div class="text-xs text-gray-500 space-y-2">
                            <div class="flex items-center">ğŸ“ <input v-model="p.mapLink" placeholder="åœ°å€..." class="ml-2 w-full bg-transparent border-b border-black/5"></div>
                            <div class="flex items-center">ğŸ´ <input v-model="p.eat" placeholder="é£²é£Ÿ..." class="ml-2 w-full bg-transparent border-b border-black/5"></div>
                        </div>
                        <textarea v-model="p.note" placeholder="è©³ç´°å‚™è¨»..." class="w-full text-xs bg-gray-50 p-3 rounded-xl h-20 outline-none"></textarea>
                    </div>
                </div>
                <button @click="addPlan" class="w-full py-4 rounded-2xl border-2 border-dashed border-black/20 font-bold opacity-40">+ æ–°å¢è¡Œç¨‹é»</button>
            </div>

            <div v-show="tab === 'map'" class="space-y-4">
                <div id="map"></div>
                <p class="text-[10px] text-center opacity-40">åœ°åœ–æ•¸æ“šç”± OpenStreetMap æä¾›</p>
            </div>

            <div v-if="tab === 'members'" class="card-muji p-8 space-y-6">
                <h3 class="text-xl font-black">ğŸ‘¥ æ—…ä¼´æˆå“¡</h3>
                <div class="flex gap-2">
                    <input v-model="newMemberName" placeholder="æˆå“¡å§“å..." class="flex-grow p-3 rounded-xl bg-gray-100 outline-none">
                    <button @click="addMember" class="px-6 bg-black text-white rounded-xl font-bold">æ–°å¢</button>
                </div>
                <div class="space-y-3">
                    <div v-for="(m, idx) in members" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm">
                        <span class="font-bold">{{ m }}</span>
                        <button @click="members.splice(idx, 1)" class="text-xs text-red-400">ç§»é™¤</button>
                    </div>
                </div>
            </div>

            </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                const isSetup = ref(false); const tab = ref('list'); const selectedDay = ref(1);
                const menuOpen = ref(false); const newMemberName = ref('');
                const setup = ref({ destination: '', startDate: '', endDate: '' });
                const areaInfo = ref({}); // ç”¨ä¾†å„²å­˜æ¯ä¸€å¤©çš„å€åŸŸè³‡è¨Š
                const itineraryData = ref({}); const members = ref([]);
                
                const timeSlots = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0') + ':00');

                onMounted(() => {
                    const saved = localStorage.getItem('myTripData_v3');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        itineraryData.value = parsed.itinerary || {};
                        setup.value = parsed.setup || setup.value;
                        members.value = parsed.members || [];
                        areaInfo.value = parsed.areaInfo || {};
                        if (setup.value.destination) isSetup.value = true;
                    }
                });

                watch([itineraryData, setup, members, areaInfo], () => {
                    localStorage.setItem('myTripData_v3', JSON.stringify({ 
                        itinerary: itineraryData.value, setup: setup.value, members: members.value, areaInfo: areaInfo.value 
                    }));
                }, { deep: true });

                // åœ°åœ–èˆ‡æ¨™è¨˜é‚è¼¯
                let map, markers = [];
                const updateMapMarkers = (focusLoc) => {
                    setTimeout(() => {
                        if (!map) { 
                            map = L.map('map').setView([25, 121], 10); 
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
                        }
                        markers.forEach(m => map.removeLayer(m)); markers = [];
                        currentPlans.value.forEach(p => {
                            if (p.mapLink) {
                                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(p.mapLink)}`)
                                .then(r => r.json()).then(data => {
                                    if (data[0]) {
                                        const m = L.marker([data[0].lat, data[0].lon]).addTo(map).bindPopup(p.loc || p.mapLink);
                                        markers.push(m);
                                        if (focusLoc === p.mapLink) map.flyTo([data[0].lat, data[0].lon], 15);
                                    }
                                });
                            }
                        });
                    }, 200);
                };

                const goToMap = (loc) => { if(loc) { tab.value = 'map'; updateMapMarkers(loc); } };
                const addMember = () => { if(newMemberName.value) { members.value.push(newMemberName.value); newMemberName.value = ''; } };
                const resetToHome = () => { if(confirm('ç¢ºå®šè¦å›åˆ°é¦–é ä¸¦ä¿®æ”¹æ—…ç¨‹å—ï¼Ÿæ•¸æ“šæœƒä¿ç•™ã€‚')) { isSetup.value = false; menuOpen.value = false; } };
                
                const totalDays = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return 1;
                    return Math.max(1, Math.ceil(Math.abs(new Date(setup.value.endDate) - new Date(setup.value.startDate)) / 86400000) + 1);
                });
                const currentPlans = computed(() => {
                    const key = `day_${selectedDay.value}`;
                    if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    return itineraryData.value[key];
                });
                const addPlan = () => currentPlans.value.push({ ampm: 'ä¸Šåˆ', time: '09:00', loc: '', mapLink: '', eat: '', note: '' });
                const finishSetup = () => { if(setup.value.destination) isSetup.value = true; };

                return { isSetup, setup, totalDays, tab, selectedDay, itineraryData, currentPlans, finishSetup, addPlan, timeSlots, menuOpen, members, newMemberName, addMember, resetToHome, areaInfo, updateMapMarkers, goToMap };
            }
        }).mount('#app');
    </script>
</body>
</html>
