<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Travel Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --mocha: #bda38f; --latte: #e8e2d6; --dark-text: #433422; --deep-banner: #333333; }
        body { background-color: var(--latte); color: var(--dark-text); font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        [v-cloak] { display: none; }
        .card-muji { background: rgba(255, 255, 255, 0.85); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .status-banner { background: var(--deep-banner); color: white; border-radius: 20px; padding: 24px; }
        .timeline-line { position: absolute; left: 42px; top: 0; bottom: 0; width: 1px; background: rgba(67, 52, 34, 0.15); z-index: 0; }
        .input-box { background: #ffffff; border-radius: 12px; padding: 10px 14px; width: 100%; font-size: 14px; border: 1px solid rgba(0,0,0,0.05); outline: none; }
        .time-badge { background: white; border-radius: 14px; width: 95px; padding: 8px 4px; text-align: center; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .select-field { background: transparent; font-weight: bold; font-size: 14px; outline: none; width: 100%; text-align: center; cursor: pointer; }
        #map { height: 350px; border-radius: 24px; border: 6px solid white; width: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .checkbox-custom { width: 22px; height: 22px; border: 2px solid var(--mocha); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .checkbox-custom.checked { background: var(--mocha); color: white; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="!isSetup" class="fixed inset-0 z-[100] bg-[#e8e2d6] flex flex-col items-center justify-center px-8">
            <div class="card-muji w-full max-sm p-10 space-y-6">
                <div class="text-center"><h1 class="text-2xl font-bold">Travel Planner</h1></div>
                <div class="space-y-4">
                    <input v-model="setup.destination" placeholder="ç›®çš„åœ° (ä¾‹å¦‚ï¼šæ±äº¬)" class="input-box py-4 text-center">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" v-model="setup.startDate" class="input-box text-xs">
                        <input type="date" v-model="setup.endDate" class="input-box text-xs">
                    </div>
                    <button @click="finishSetup" class="w-full py-4 bg-[#333333] text-white rounded-xl font-bold">START JOURNEY</button>
                </div>
            </div>
        </div>

        <div v-else class="max-w-md mx-auto min-h-screen">
            <div class="px-6 pt-8">
                <div class="status-banner flex justify-between items-center shadow-xl">
                    <div>
                        <h2 class="text-2xl font-bold">{{ formattedDate }}</h2>
                        <p class="text-xs opacity-70 mt-1 uppercase">ğŸ“ {{ setup.destination }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-black">{{ weatherIcon }} {{ weather.temp }}Â°C</div>
                        <p class="text-[10px] font-bold opacity-70 uppercase">{{ weather.desc }}</p>
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto px-6 space-x-3 no-scrollbar my-6">
                <div v-for="d in totalDays" :key="d" @click="selectedDay = d"
                     :class="['flex-shrink-0 px-4 h-12 flex items-center justify-center rounded-2xl bg-white/40 transition-all font-bold', { 'bg-[#333333] text-white shadow-lg': selectedDay === d }]">
                    Day {{ d }}
                </div>
            </div>

            <main class="px-6 space-y-8 pb-24">
                <div class="flex space-x-6 text-sm font-bold border-b border-white/30 pb-2 overflow-x-auto no-scrollbar">
                    <button @click="tab = 'list'" :class="tab === 'list' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">è¡Œç¨‹</button>
                    <button @click="tab = 'map'; updateMapMarkers()" :class="tab === 'map' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åœ°åœ–</button>
                    <button @click="tab = 'items'" :class="tab === 'items' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">å¿…å‚™ç”¨å“</button>
                    <button @click="tab = 'finance'" :class="tab === 'finance' ? 'opacity-100 border-b-2 border-[#333]' : 'opacity-20'">åˆ†å¸³</button>
                </div>

                <div v-if="tab === 'list'" class="space-y-12 relative">
                    <div class="timeline-line"></div>
                    <div v-for="(p, i) in currentPlans" :key="i" class="relative flex items-start space-x-6">
                        <div class="flex flex-col items-center">
                            <div class="time-badge">
                                <button @click="p.ampm = p.ampm === 'ä¸Šåˆ' ? 'ä¸‹åˆ' : 'ä¸Šåˆ'" class="text-[9px] font-black bg-gray-100 px-2 py-0.5 rounded mb-1">{{ p.ampm }}</button>
                                <div class="flex items-center justify-center space-x-1">
                                    <span class="text-[10px]">â°</span>
                                    <select v-model="p.time" class="select-field text-xs">
                                        <option v-for="t in timeSlots" :key="t" :value="t">{{ t }}</option>
                                    </select>
                                </div>
                            </div>
                            <select v-model="p.transport" class="mt-2 text-[10px] bg-white rounded p-1 outline-none">
                                <option>ğŸš— äº¤é€š</option><option>ğŸš‡ åœ°éµ</option><option>ğŸš„ JR</option><option>ğŸš¶ æ­¥è¡Œ</option>
                            </select>
                        </div>
                        <div class="card-muji flex-grow p-5 space-y-4" @click="tab = 'map'; updateMapMarkers(p.mapLink)">
                            <input v-model="p.loc" placeholder="è¡Œç¨‹æ¨™é¡Œ..." class="text-base font-bold bg-transparent outline-none w-full" @click.stop>
                            <div class="flex items-center bg-[#f9f9f9] rounded-xl px-3 border border-black/5">
                                <span class="text-sm mr-2">ğŸ“</span>
                                <input v-model="p.mapLink" placeholder="åœ°é»åç¨± (é»æ“Šå¡ç‰‡å®šä½)" class="bg-transparent py-2 w-full text-sm outline-none" @click.stop>
                            </div>
                            <textarea v-model="p.note" placeholder="è©³ç´°å‚™è¨»..." class="input-box h-16 resize-none opacity-60 text-xs bg-[#f9f9f9]" @click.stop></textarea>
                        </div>
                    </div>
                    <button @click="addPlan" class="w-full py-5 rounded-2xl border-2 border-dashed border-white/60 text-[10px] font-bold opacity-40">+ ADD PLAN</button>
                </div>

                <div v-show="tab === 'map'" class="space-y-4"><div id="map"></div></div>

                <div v-if="tab === 'items'" class="card-muji p-6 space-y-6">
                    <div class="flex space-x-2">
                        <select v-model="newItem" class="input-box flex-grow">
                            <option v-for="opt in itemOptions" :key="opt" :value="opt">{{ opt }}</option>
                        </select>
                        <button @click="addItem" class="px-4 bg-[#333] text-white rounded-xl text-sm font-bold">æ–°å¢</button>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(item, idx) in checklist" :key="idx" class="flex items-center justify-between bg-white/50 p-3 rounded-xl">
                            <div class="flex items-center space-x-3" @click="item.done = !item.done">
                                <div :class="['checkbox-custom', { 'checked': item.done }]"><span v-if="item.done">âœ“</span></div>
                                <span :class="{ 'line-through opacity-40': item.done }">{{ item.name }}</span>
                            </div>
                            <button @click="checklist.splice(idx, 1)" class="opacity-20 text-xs">âœ•</button>
                        </div>
                    </div>
                    <p class="text-center text-sm font-bold opacity-60 border-t pt-4">å·²å®Œæˆï¼š{{ totalPrepared }} / {{ checklist.length }}</p>
                </div>

                <div v-if="tab === 'finance'" class="card-muji p-6 space-y-6">
                    <div class="space-y-4">
                        <input type="number" v-model="finance.amount" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" class="input-box text-xl font-bold text-center">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <label class="text-[10px] block opacity-50">åŒ¯ç‡ (å°å°å¹£)</label>
                                <input type="number" v-model="finance.rate" class="w-full bg-transparent font-bold">
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <label class="text-[10px] block opacity-50">ä»˜æ¬¾äºº</label>
                                <input v-model="finance.payer" class="w-full bg-transparent font-bold">
                            </div>
                        </div>
                        <input v-model="finance.receiver" placeholder="åˆ†æ”¤äººå§“å (ç”¨é€—è™Ÿéš”é–‹)" class="input-box text-sm">
                    </div>
                    <div class="bg-[#333] p-8 rounded-[30px] text-white text-center">
                        <p class="text-[10px] opacity-60 uppercase mb-1">å°å¹£ç¸½é¡ NT$ {{ Math.round(finance.amount * finance.rate) }}</p>
                        <div class="h-[1px] bg-white/10 my-3"></div>
                        <p v-if="splitInfo" class="text-lg font-bold text-[#bda38f] italic">{{ splitInfo }}</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                const isSetup = ref(false); const tab = ref('list'); const selectedDay = ref(1);
                const setup = ref({ destination: '', startDate: '', endDate: '' });
                const weather = ref({ temp: '--', desc: 'æŠ“å–ä¸­' });
                const finance = ref({ amount: 0, rate: 0.22, payer: 'æˆ‘', receiver: 'æ—…ä¼´' });
                const itineraryData = ref({});
                const newItem = ref('è­·ç…§/ç°½è­‰'); const checklist = ref([]);
                const itemOptions = ["è­·ç…§/ç°½è­‰", "è¡Œå‹•é›»æº", "ç¶²å¡/Wifiæ©Ÿ", "æ—¥å¹£/å¤–å¹£", "æ›æ´—è¡£ç‰©", "ç›¥æ´—ç”¨å“", "å¸¸å‚™è—¥å“", "é›¨å…·", "å……é›»ç·š", "ç›¸æ©Ÿ"];
                let map, markers = [];

                const timeSlots = Array.from({length: 24}, (_, i) => [i.toString().padStart(2, '0') + ':00', i.toString().padStart(2, '0') + ':30']).flat();

                onMounted(() => {
                    const saved = localStorage.getItem('myTripData');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        itineraryData.value = parsed.itinerary || {};
                        setup.value = parsed.setup || setup.value;
                        checklist.value = parsed.checklist || [];
                        if (setup.value.destination) { isSetup.value = true; fetchWeather(); }
                    }
                });

                watch([itineraryData, setup, finance, checklist], () => {
                    localStorage.setItem('myTripData', JSON.stringify({ itinerary: itineraryData.value, setup: setup.value, checklist: checklist.value }));
                }, { deep: true });

                const fetchWeather = async () => {
                    try {
                        const res = await fetch(`https://wttr.in/${encodeURIComponent(setup.value.destination)}?format=j1`);
                        const data = await res.json();
                        weather.value = { temp: data.current_condition[0].temp_C, desc: data.current_condition[0].weatherDesc[0].value };
                    } catch (e) { weather.value = { temp: '20', desc: 'Sunny' }; }
                };

                const weatherIcon = computed(() => {
                    const desc = weather.value.desc.toLowerCase();
                    if (desc.includes('sun') || desc.includes('clear')) return 'â˜€ï¸';
                    if (desc.includes('cloud')) return 'â˜ï¸';
                    if (desc.includes('rain')) return 'ğŸŒ§ï¸';
                    if (desc.includes('snow')) return 'â„ï¸';
                    return 'ğŸŒ¤ï¸';
                });

                const splitInfo = computed(() => {
                    if (!finance.value.amount || !finance.value.receiver) return "";
                    const totalTWD = finance.value.amount * finance.value.rate;
                    const receivers = finance.value.receiver.split(',');
                    const perPerson = Math.round(totalTWD / (receivers.length + 1));
                    return `${receivers.join('ã€')} æ‡‰çµ¦ ${finance.value.payer} NT$ ${perPerson}`;
                });

                const updateMapMarkers = (focusLoc) => {
                    setTimeout(() => {
                        if (!map) { map = L.map('map').setView([25, 121], 10); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
                        markers.forEach(m => map.removeLayer(m)); markers = [];
                        currentPlans.value.forEach(p => {
                            if (p.mapLink) fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(p.mapLink)}`)
                                .then(r => r.json()).then(data => {
                                    if (data[0]) {
                                        const m = L.marker([data[0].lat, data[0].lon]).addTo(map).bindPopup(p.loc || p.mapLink);
                                        markers.push(m); if (focusLoc === p.mapLink) map.flyTo([data[0].lat, data[0].lon], 15);
                                    }
                                });
                        });
                    }, 200);
                };

                const addItem = () => { if(newItem.value) { checklist.value.push({ name: newItem.value, done: false }); } };
                const totalPrepared = computed(() => checklist.value.filter(i => i.done).length);
                const totalDays = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return 1;
                    return Math.max(1, Math.ceil(Math.abs(new Date(setup.value.endDate) - new Date(setup.value.startDate)) / 86400000) + 1);
                });
                const formattedDate = computed(() => {
                    if (!setup.value.startDate) return '';
                    const d = new Date(setup.value.startDate); d.setDate(d.getDate() + (selectedDay.value - 1));
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                });
                const currentPlans = computed(() => {
                    const key = `day_${selectedDay.value}`;
                    if (!itineraryData.value[key]) itineraryData.value[key] = [];
                    return itineraryData.value[key];
                });
                const addPlan = () => currentPlans.value.push({ ampm: 'ä¸Šåˆ', time: '09:00', transport: 'ğŸš— äº¤é€š', loc: '', mapLink: '', note: '' });
                const finishSetup = () => { if(setup.value.destination) { isSetup.value = true; fetchWeather(); } };

                return { isSetup, setup, totalDays, tab, selectedDay, finance, itineraryData, currentPlans, weather, weatherIcon, formattedDate, finishSetup, addPlan, updateMapMarkers, timeSlots, newItem, checklist, itemOptions, addItem, totalPrepared, splitInfo };
            }
        }).mount('#app');
    </script>
</body>
</html>
